name: 'Release'
run-name: 'Cut Release ${{ github.event.release.tag_name || github.event.inputs.release-tag}}'
concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  cancel-in-progress: true
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release-tag:
        description: 'Release tag ([servicename-]v#.#.#[-rc#])'
        required: true
  pull_request:
    branches:
      - main

env:
  FULL_TAG: v0.0.1
  DOCKER_HUB_PROFILE: projectlibertylabs
  ALL_SERVICES: '["account", "content-publishing", "content-watcher", "graph"]'

jobs:
  build-and-publish-container-image:
    name: Build and publish container image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [account]
    steps:
      - name: Check Out Repo
        uses: actions/checkout@v4
      - name: Deploy Service
        run: |
          echo "Deploying service: ${{ matrix.service }}"
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: |
            linux/amd64
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64, linux/arm64, darwin/arm64
          push: false
          file: Docker/Dockerfile.${{ matrix.service }}
          tags: "test"
